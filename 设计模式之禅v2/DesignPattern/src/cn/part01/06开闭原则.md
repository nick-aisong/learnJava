开闭原则
========

开闭原则的定义：
Software entities like classes,modules and functions should be open for extension but closed for
modifications.（一个软件实体如类、模块和函数应该对扩展开放，对修改关闭。）

开闭原则的定义已经非常明确地告诉我们：软件实体应该对扩展开放，对修改关闭，其
含义是说一个软件实体应该通过扩展来实现变化，而不是通过修改已有的代码来实现变化。
那什么又是软件实体呢？软件实体包括以下几个部分：
- 项目或软件产品中按照一定的逻辑规则划分的模块
- 抽象和类
- 方法

一个软件产品只要在生命期内，都会发生变化，既然变化是一个既定的事实，我们就应
该在设计时尽量适应这些变化，以提高项目的稳定性和灵活性，真正实现“拥抱变化”。开闭
原则告诉我们应尽量通过扩展软件实体的行为来实现变化，而不是通过修改已有的代码来完
成变化，它是为软件实体的未来事件而制定的对现行开发设计进行约束的一个原则

注意：我们把价格定义为int类型并不是错误，在非金融类项目中对货币处理时，一般取
2位精度，通常的设计方法是在运算过程中扩大100倍，在需要展示时再缩小100倍，减少精
度带来的误差

注意：开闭原则对扩展开放，对修改关闭，并不意味着不做任何修改，低层模块的变
更，必然要有高层模块进行耦合，否则就是一个孤立无意义的代码片段

我们可以把变化归纳为以下三种类型：
- 逻辑变化
- 子模块变化
- 可见视图变化
（可见视图是提供给客户使用的界面，如JSP程序、Swing界面等，该部分的变化一般会引
 起连锁反应（特别是在国内做项目，做欧美的外包项目一般不会影响太大））

放弃修改历史的想法吧，一个项目的基本路径应该是这样
的：项目开发、重构、测试、投产、运维，其中的重构可以对原有的设计和代码进行修改，
运维尽量减少对原有代码的修改，保持历史代码的纯洁性，提高系统的稳定性

开闭原则是最基础的一个原则，前五章节介绍的原则都是开闭原则的具体形态，
也就是说前五个原则就是指导设计的工具和方法，而开闭原则才是其精神领袖

开闭原则的重要性：
1. 开闭原则对测试的影响
（新增加的类，新增加的测试方法，只要保证新增加类是正确的就可以了）
2. 开闭原则可以提高复用性
（在面向对象的设计中，所有的逻辑都是从原子逻辑组合而来的，而不是在一个类中独立
实现一个业务逻辑。只有这样代码才可以复用，粒度越小，被复用的可能性就越大。那为什
么要复用呢？减少代码量，避免相同的逻辑分散在多个角落，避免日后的维护人员为了修改
一个微小的缺陷或增加新功能而要在整个项目中到处查找相关的代码，然后发出对开发人
员“极度失望”的感慨。那怎么才能提高复用率呢？缩小逻辑粒度，直到一个逻辑不可再拆分
为止）
3. 开闭原则可以提高可维护性
（维护人员最乐意做的事情就是扩展一个类，而不是修改一个类）
4. 面向对象开发的要求
（万物皆对象，我们需要把所有的事物都抽象成对象，然后针对对象进行操作，但是万物
皆运动，有运动就有变化，有变化就要有策略去应对，怎么快速应对呢？这就需要在设计之
初考虑到所有可能变化的因素，然后留下接口，等待“可能”转变为“现实”）

如何使用开闭原则
1. 抽象约束
（抽象是对一组事物的通用描述，没有具体的实现，也就表示它可以有非常多的可能性，
可以跟随需求的变化而变化。因此，通过接口或抽象类可以约束一组可能变化的行为，并且
能够实现对扩展开放，其包含三层含义：第一，通过接口或抽象类约束扩展，对扩展进行边
界限定，不允许出现在接口或抽象类中不存在的public方法；第二，参数类型、引用对象尽
量使用接口或者抽象类，而不是实现类；第三，抽象层尽量保持稳定，一旦确定即不允许修
改。还是以书店为例，目前只是销售小说类书籍，单一经营毕竟是有风险的，于是书店新增
加了计算机书籍，它不仅包含书籍名称、作者、价格等信息，还有一个独特的属性：面向的
是什么领域，也就是它的范围，比如是和编程语言相关的，还是和数据库相关的，等等
。要实现对扩展开放，首要的前提条件就是抽象约束）

2. 元数据（metadata）控制模块行为
（编程是一个很苦很累的活，那怎么才能减轻我们的压力呢？答案是尽量使用元数据来控
制程序的行为，减少重复开发。什么是元数据？用来描述环境和数据的数据，通俗地说就是
配置参数，参数可以从文件中获得，也可以从数据库中获得。举个非常简单的例子，login方
法中提供了这样的逻辑：先检查IP地址是否在允许访问的列表中，然后再决定是否需要到数
据库中验证密码（如果采用SSH架构，则可以通过Struts的拦截器来实现），该行为就是一个
典型的元数据控制模块行为的例子，其中达到极致的就是控制反转（Inversion of Control），
使用最多的就是Spring容器，在SpringContext配置文件中
。通过扩展一个子类，修改配置文件，完成了业务变化，这也是采用框架的好处）

3. 制定项目章
（在一个团队中，建立项目章程是非常重要的，因为章程中指定了所有人员都必须遵守的
约定，对项目来说，约定优于配置。相信大家都做过项目，会发现一个项目会产生非常多的
配置文件。举个简单的例子，以SSH项目开发为例，一个项目中的Bean配置文件就非常多，
管理非常麻烦。如果需要扩展，就需要增加子类，并修改SpringContext文件。然而，如果你
在项目中指定这样一个章程：所有的Bean都自动注入，使用Annotation进行装配，进行扩展
时，甚至只用写一个子类，然后由持久层生成对象，其他的都不需要修改，这就需要项目内
约束，每个项目成员都必须遵守，该方法需要一个团队有较高的自觉性，需要一个较长时间
的磨合，一旦项目成员都熟悉这样的规则，比通过接口或抽象类进行约束效率更高，而且扩
展性一点也没有减少）

4. 封装变化
（对变化的封装包含两层含义：第一，将相同的变化封装到一个接口或抽象类中；第二，
将不同的变化封装到不同的接口或抽象类中，不应该有两个不同的变化出现在同一个接口或
抽象类中。封装变化，也就是受保护的变化（protected variations），找出预计有变化或不稳
定的点，我们为这些变化点创建稳定的接口，准确地讲是封装可能发生的变化，一旦预测到
或“第六感”发觉有变化，就可以进行封装，23个设计模式都是从各个不同的角度对变化进行
封装的）

软件设计最大的难题就是应对需求的变化，但是纷繁复杂的需求变化又是不可预料的。
我们要为不可预料的事情做好准备，这本身就是一件非常痛苦的事情，但是大师们还是给我
们提出了非常好的6大设计原则以及23个设计模式来“封装”未来的变化，我们在前5章中讲过
如下设计原则

- Single Responsibility Principle：单一职责原则
- Open Closed Principle：开闭原则
- Liskov Substitution Principle：里氏替换原则
- Law of Demeter：迪米特法则
- Interface Segregation Principle：接口隔离原则
- Dependence Inversion Principle：依赖倒置原则

我们在使用开闭原则时要注意以下几个问题
- 开闭原则也只是一个原则
（开闭原则只是精神口号，实现拥抱变化的方法非常多，并不局限于这6大设计原则，但
是遵循这6大设计原则基本上可以应对大多数变化。因此，我们在项目中应尽量采用这6大原
则，适当时候可以进行扩充，例如通过类文件替换的方式完全可以解决系统中的一些缺陷。
大家在开发中比较常用的修复缺陷的方法就是类替换，比如一个软件产品已经在运行中，发
现了一个缺陷，需要修正怎么办？如果有自动更新功能，则可以下载一个.class文件直接覆
盖原有的class，重新启动应用（也不一定非要重新启动）就可以解决问题，也就是通过类文
件的替换方式修正了一个缺陷，当然这种方式也可以应用到项目中，正在运行中的项目发现
需要增加一个新功能，通过修改原有实现类的方式就可以解决这个问题，前提条件是：类必
须做到高内聚、低耦合，否则类文件的替换会引起不可预料的故障。）
- 项目规章非常重要
（如果你是一位项目经理或架构师，应尽量让自己的项目成员稳定，稳定后才能建立高效
的团队文化，章程是一个团队所有成员共同的知识结晶，也是所有成员必须遵守的约定。优
秀的章程能带给项目带来非常多的好处，如提高开发效率、降低缺陷率、提高团队士气、提
高技术成员水平，等等）
- 预知变化
（在实践中过程中，架构师或项目经理一旦发现有发生变化的可能，或者变化曾经发生
过，则需要考虑现有的架构是否可以轻松地实现这一变化。架构师设计一套系统不仅要符合
现有的需求，还要适应可能发生的变化，这才是一个优良的架构）

开闭原则是一个终极目标，任何人包括大师级人物都无法百分之百做到，但朝这个方向
努力，可以非常显著地改善一个系统的架构，真正做到“拥抱变化”
