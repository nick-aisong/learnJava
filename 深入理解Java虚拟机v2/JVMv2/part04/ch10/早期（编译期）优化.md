早期（编译期）优化
========
从计算机程序出现的第一天起，对效率的追求就是程序天生的坚定信仰，这个过程犹如
一场没有终点、永不停歇的F1方程式竞赛，程序员是车手，技术平台则是在赛道上飞驰的赛车

##### 10.1 概述
Java语言的“编译期”其实是一段“不确定”的操作过程，因为它可能是指一个前端编译器
（其实叫“编译器的前端”更准确一些）把*.java文件转变成*.class文件的过程；也可能是指虚
拟机的后端运行期编译器（JIT编译器，Just In Time Compiler）把字节码转变成机器码的过
程；还可能是指使用静态提前编译器（AOT编译器，Ahead Of Time Compiler）直接把*.java
文件编译成本地机器代码的过程。下面列举了这3类编译过程中一些比较有代表性的编译器

- 前端编译器：Sun的Javac、Eclipse JDT中的增量式编译器（ECJ）

(JDT官方站点：http://www.eclipse.org/jdt/ )

- JIT编译器：HotSpot VM的C1、C2编译器

- AOT编译器：GNU Compiler for the Java（GCJ）、Excelsior JET

(GCJ官方站点：http://gcc.gnu.org/java/ )

(GCJ官方站点：http://gcc.gnu.org/java/ )

这3类过程中最符合大家对Java程序编译认知的应该是第一类，在本章的后续文字里，
笔者提到的“编译期”和“编译器”都仅限于第一类编译过程，把第二类编译过程留到下一章中
讨论。限制了编译范围后，我们对于“优化”二字的定义就需要宽松一些，因为Javac这类编译
器对代码的运行效率几乎没有任何优化措施（在JDK 1.3之后，Javac的-O优化参数就不再有
意义）。虚拟机设计团队把对性能的优化集中到了后端的即时编译器中，这样可以让那些不
是由Javac产生的Class文件（如JRuby、Groovy等语言的Class文件）也同样能享受到编译器优
化所带来的好处。但是Javac做了许多针对Java语言编码过程的优化措施来改善程序员的编码
风格和提高编码效率。相当多新生的Java语法特性，都是靠编译器的“语法糖”来实现，而不
是依赖虚拟机的底层改进来支持，可以说，Java中即时编译器在运行期的优化过程对于程序
运行来说更重要，而前端编译器在编译期的优化过程对于程序编码来说关系更加密切

##### 10.2 Javac编译器
分析源码是了解一项技术的实现内幕最有效的手段，Javac编译器不像HotSpot虚拟机那
样使用C++语言（包含少量C语言）实现，它本身就是一个由Java语言编写的程序，这为纯
Java的程序员了解它的编译过程带来了很大的便利

###### 10.2.1 Javac的源码与调试
Javac的源码存放在JDK_SRC_HOME/langtools/src/share/classes/com/sun/tools/javac中，
除了JDK自身的API外，就只引用了JDK_SRC_HOME/langtools/src/share/classes/com/sun/*里面
的代码，调试环境建立起来简单方便，因为基本上不需要处理依赖关系

(关于如何获取OpenJDK源码，请参考本书第1章)

以Eclipse IDE环境为例，先建立一个名为“Compiler_javac”的Java工程，然后把
JDK_SRC_HOME/langtools/src/share/classes/com/sun/*目录下的源文件全部复制到工程的源码
目录中，如图10-1所示

导入代码期间，源码文件“AnnotationProxy Maker.java”可能会提示“Access Restriction”，
被Eclipse拒绝编译，如图10-2所示

测试<sup>[2]</sup>





(图片来源：http://openjdk.java.net/groups/compiler/doc/compilation-overview/index.html ，本书
对相关术语进行了翻译)










###### 10.2.2 解析与填充符号表
















###### 10.2.3 注解处理器
















###### 10.2.4 语义分析与字节码生成




















##### 10.3 Java语法糖的味道




















###### 10.3.1 泛型与类型擦除
















###### 10.3.2 自动装箱、拆箱与遍历循环



















###### 10.3.3 条件编译














##### 10.4 实战：插入式注解处理器













###### 10.4.1 实战目标














###### 10.4.2 代码实现
















###### 10.4.3 运行与测试

















###### 10.4.4 其他应用案例









##### 10.5 本章小结

















